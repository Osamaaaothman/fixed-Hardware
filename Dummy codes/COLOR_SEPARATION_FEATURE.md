# ðŸŽ¨ Multi-Color Mode (Color Separation Feature)

## Overview

The multi-color mode automatically detects colors in your image and separates them into different layers. Each layer will be drawn with a different pen, with automatic pause commands for pen changes.

## How It Works

### 1. Color Detection

- The system analyzes your uploaded image pixel by pixel
- Identifies up to 8 unique colors (excluding white background)
- Colors are sorted by frequency (most common first)
- Similar colors within a tolerance of 10 RGB units are grouped together

### 2. Layer Separation

- Each detected color becomes a separate layer
- A black & white version is created for each layer
- Only pixels matching that specific color appear as black in the layer
- All other pixels are white (background)

### 3. G-code Generation

- Each layer is vectorized and converted to G-code independently
- Layers are combined into a single G-code file with clear separation
- **M0 pause commands** are inserted between layers for pen changes
- Each layer includes a header comment with color information

## How to Use

1. **Enable Multi-Color Mode**

   - Check the "ðŸŽ¨ Multi-Color Mode (Color Separation)" checkbox in Settings
   - Upload your colored image
   - Click "Generate G-code"

2. **Review the Layers**

   - The ColorLayers panel will show:
     - Each detected color with a color swatch
     - Preview of what each layer looks like
     - Number of pixels for each color
     - Estimated drawing time per layer

3. **Prepare Your Pens**

   - Note the order of colors (Layer 1, Layer 2, etc.)
   - Prepare pens/markers matching each color
   - Colors are listed with their hex codes (e.g., #FF0000 for red)

4. **Run the G-code**
   - Send the G-code file to your plotter
   - Start with the pen for Layer 1 color
   - When the plotter pauses (M0 command):
     - The display will show which color to change to
     - Swap the pen with the next layer's color
     - Resume the plotter

## G-code Format

```gcode
; Multi-Color G-code
; Generated by Image to G-code Converter
; Total layers: 3

; ===== LAYER 1: Red (#FF0000) =====
; Paths: 45, Distance: 1250.5mm
G21 ; Set to millimeters
G90 ; Absolute positioning
G0 Z5 ; Pen up
G0 X0 Y0 ; Move to start
... [drawing commands for red layer] ...

G0 Z5 ; Pen up
M0 ; Pause for pen change
; Change to pen color: Green (#00FF00)

; ===== LAYER 2: Green (#00FF00) =====
; Paths: 32, Distance: 980.2mm
... [drawing commands for green layer] ...

G0 Z5 ; Pen up
M0 ; Pause for pen change
; Change to pen color: Blue (#0000FF)

; ===== LAYER 3: Blue (#0000FF) =====
; Paths: 28, Distance: 850.7mm
... [drawing commands for blue layer] ...
```

## Color Naming

The system provides approximate color names:

- **Black** - Very dark colors (brightness < 50)
- **Dark Gray** - Dark but not black
- **Gray** - Medium gray tones
- **Light Gray** - Light gray tones
- **Red** - Red dominant colors
- **Orange** - Red + Green mix
- **Green** - Green dominant colors
- **Cyan** - Green + Blue mix
- **Blue** - Blue dominant colors
- **Magenta** - Red + Blue mix
- **Yellow** - Red + Green bright mix
- **Mixed** - Colors that don't fit other categories

## Tips for Best Results

1. **Image Preparation**

   - Use images with distinct, solid colors
   - Avoid gradients or color blending
   - Reduce your image to key colors in an image editor first
   - Simple cartoon-style images work best

2. **Pen Selection**

   - Use pens with consistent line width
   - Test pens on scrap paper first
   - Make sure each pen color matches the detected layers
   - Keep pens in order for quick swapping

3. **Plotter Setup**

   - Ensure your plotter supports M0 (pause) commands
   - Test with a simple 2-color image first
   - Have all pens ready before starting
   - Consider the total drawing time (shown in stats)

4. **File Size Management**
   - Multi-color mode processes multiple layers
   - Use smaller image sizes (200-300px) for complex images
   - Enable "Remove Noise" to eliminate tiny artifacts
   - Lower detail level if file size becomes too large

## Technical Details

### Backend Processing

- File: `backend/utils/colorSeparation.js`
- Uses Sharp for raw pixel access and analysis
- Creates binary (black/white) layers for each color
- Returns color info, layer images, and pixel counts

### Frontend Display

- Component: `frontend/src/components/ColorLayers.jsx`
- Shows color swatches with hex codes
- Displays layer previews
- Shows per-layer statistics
- Calculates total estimated time

### Statistics

- **Layer Count**: Number of color layers detected
- **Path Count**: Total paths across all layers
- **Drawing Distance**: Combined distance for all layers
- **Estimated Time**: Drawing time + pen change time
- **Per-Layer Stats**: Individual stats for each color

## Limitations

- Maximum 8 colors (most frequent colors are used)
- Color tolerance: Â±10 RGB units for grouping
- White pixels (R>250, G>250, B>250) are treated as background
- Your plotter must support M0 pause commands
- Manual pen changes required (not automatic)

## Troubleshooting

**Too many layers detected:**

- Pre-process your image to reduce colors
- Use "posterize" or "reduce colors" in an image editor

**Colors not separated correctly:**

- Increase contrast in your source image
- Convert image to indexed color mode with limited palette
- Ensure colors are distinct (not similar shades)

**Plotter doesn't pause:**

- Check if your plotter firmware supports M0
- Try M00 or M1 instead (edit G-code manually)
- Some plotters may need custom pause commands

**Layers appear empty:**

- Color tolerance might be too strict
- Try different image formats (PNG works best)
- Ensure image has actual color variation

## Example Workflow

1. Create a simple logo with 3 solid colors (red, blue, yellow)
2. Export as PNG with flat colors
3. Upload to the converter
4. Enable Multi-Color Mode
5. Generate G-code (should detect 3 layers)
6. Review layers - verify each color is separated correctly
7. Prepare red, blue, and yellow pens
8. Start plotter with red pen for Layer 1
9. When paused, swap to blue pen for Layer 2
10. When paused again, swap to yellow pen for Layer 3
11. Final result: Multi-color drawing!

---

**Note**: This feature works best with images that have clear, distinct colors. For photos or complex gradients, consider converting to a limited color palette first using an image editor.
